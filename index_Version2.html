<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Geo-Explorer Pro V25 - Comprehensive Maps</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@joergdietrich/leaflet.terminator"></script>
    <!-- SunCalc Library for Sunrise/Sunset calculations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #1a73e8; --accent: #ea4335; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Inter', 'Noto Sans JP', sans-serif; overflow: hidden; background: #000; }
        #map { position: absolute; top: 0; left: 0; height: 100%; width: 100%; z-index: 10; background: #f0f0f0; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.94);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        .top-controls { z-index: 9999; }
        .bottom-controls { z-index: 9999; }

        #sidePanel { 
            position: absolute; top: 0; left: 0; bottom: 0; z-index: 10000;
            width: 420px; transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); 
            display: flex; flex-direction: column; background: white;
            box-shadow: 10px 0 50px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .panel-hidden { transform: translateX(-100%); }

        .action-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 10px;
            border-radius: 10px; font-weight: 700; font-size: 12px; transition: all 0.2s ease;
            background: #f8fafc; border: 1px solid #e2e8f0; color: #334155;
        }
        .action-btn.active-overlay { 
            background: #eff6ff; 
            border-color: #3b82f6; 
            color: #1d4ed8;
        }
        .action-btn.active-base { background: #1a73e8; color: white; border-color: #1a73e8; }

        #layerMenu { scrollbar-width: none; }
        #layerMenu::-webkit-scrollbar { display: none; }

        .image-loader {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
        }

        .close-panel-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 9500;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 9999px;
            padding: 0.5rem;
            color: #4b5563;
            transition: all 0.2s;
        }
        .close-panel-btn:hover {
            color: #ef4444;
            transform: scale(1.1);
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(5px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-5px); }
        }
        .animate-tip {
            animation: fadeInOut 10s infinite;
        }

        .filter-grayscale { filter: grayscale(100%); }
        .filter-bw { filter: grayscale(100%) contrast(150%); }
        .filter-rader-blue { filter: sepia(100%) hue-rotate(170deg) saturate(300%) brightness(0.8) contrast(1.2); }

        .clock-label {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            white-space: normal;
            word-wrap: break-word;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.4);
            text-align: center;
            pointer-events: none;
            line-height: 1.3;
            min-width: 110px;
            max-width: 160px;
            display: inline-block;
        }
        .clock-time {
            font-weight: 800;
            font-size: 1.1em;
            display: block;
            margin: 2px 0;
        }
        .clock-sun {
            font-size: 0.85em;
            opacity: 0.9;
            white-space: nowrap;
            display: block;
            margin-top: 2px;
            color: #fbbf24;
        }

        .quiz-option {
            width: 100%;
            text-align: left;
            padding: 14px 16px;
            background: white;
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 8px;
            line-height: 1.4;
            display: block;
            word-break: break-word;
        }
        .quiz-option:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }
        .quiz-option.correct {
            background: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d !important;
        }
        .quiz-option.incorrect {
            background: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c !important;
        }

        .leaflet-control-scale {
            margin-bottom: 24px !important;
            margin-left: 12px !important;
        }
        .leaflet-control-scale-line {
            background: rgba(255, 255, 255, 0.7) !important;
            backdrop-filter: blur(4px);
            border: 2px solid #1a73e8 !important;
            border-top: none !important;
            color: #1a73e8 !important;
            font-weight: 800 !important;
            font-size: 10px !important;
            text-shadow: none !important;
        }

        @media (max-width: 640px) {
            #sidePanel { width: 100%; transform: translateY(100%); left: 0; top: auto; height: 85vh; border-radius: 32px 32px 0 0; }
            .panel-hidden { transform: translateY(100%) !important; }
            .close-panel-btn { top: 1.5rem; right: 1.5rem; }
            .leaflet-control-scale { margin-bottom: 30px !important; }
            #legendPanel { bottom: 3rem !important; max-width: 95vw !important; }
        }
    </style>
</head>
<body>

    <div class="top-controls fixed top-6 left-6 right-6 pointer-events-none flex items-center justify-between gap-4">
        <div class="w-14 shrink-0"></div>

        <form onsubmit="event.preventDefault(); performSearch();" class="glass-panel flex-1 max-w-lg h-14 rounded-2xl flex items-center px-4 pointer-events-auto">
            <button type="button" onclick="toggleSidePanel()" class="p-2 text-gray-400 hover:text-blue-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <input type="text" id="searchInput" placeholder="å ´æ‰€ã‚’æ¤œç´¢..." class="flex-1 bg-transparent px-3 outline-none font-bold text-gray-800 text-sm">
            <button type="submit" id="searchBtn" class="bg-blue-600 text-white p-2.5 rounded-xl shadow-lg hover:bg-blue-700 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </button>
        </form>

        <button onclick="toggleLayerMenu()" class="glass-panel w-14 h-14 rounded-2xl flex items-center justify-center text-gray-500 hover:text-blue-600 transition-all pointer-events-auto shrink-0">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
        </button>
    </div>

    <div id="map"></div>
    
    <!-- Legend Panel -->
    <div id="legendPanel" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[5000] glass-panel px-4 py-3 rounded-2xl hidden shadow-2xl transition-all duration-300 max-w-[90vw]">
        <div id="legendTitle" class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2 text-center">å‡¡ä¾‹</div>
        <div id="legendContent" class="flex items-center gap-4 text-xs font-bold text-gray-700 whitespace-nowrap overflow-x-auto p-1">
            <!-- Dynamic Content -->
        </div>
    </div>

    <aside id="sidePanel" class="panel-hidden">
        <button onclick="closeSidePanel()" class="close-panel-btn">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>

        <div id="imageSection" class="relative w-full h-64 bg-gray-100 shrink-0 overflow-hidden">
            <div id="poiImageLoader" class="image-loader">
                <div id="loaderText" class="text-gray-400 text-[10px] font-black uppercase tracking-widest">Searching Wikipedia...</div>
            </div>
            <img id="poiImage" class="w-full h-full object-cover hidden" alt="Location view">
            <div id="noImagePlaceholder" class="w-full h-full flex flex-col items-center justify-center bg-slate-50 text-slate-300 hidden">
                <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                <span id="noImageText" class="text-[10px] font-bold uppercase tracking-widest">No Wikipedia Image</span>
            </div>
        </div>

        <div class="p-8 space-y-6 pb-20">
            <div class="space-y-4">
                <div><h2 id="poiName" class="text-3xl font-black text-gray-900 leading-tight">å ´æ‰€ã‚’é¸æŠ</h2></div>
                <div id="addressSection" class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                    <label id="labelAddr" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-1">ğŸ“ ä½æ‰€</label>
                    <p id="addrText" class="text-sm font-bold text-gray-700 leading-relaxed"></p>
                </div>
                <div id="notFoundSection" class="hidden space-y-4 pt-2">
                    <p id="notFoundMsg" class="text-sm font-medium text-gray-600 leading-relaxed">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«èª¤å­—ã‚„è„±å­—ãŒãªã„ã‹ã”ç¢ºèªãã ã•ã„ã€‚</p>
                    <button onclick="searchGoogleWeb()" id="searchGoogleBtn" class="action-btn active-base !justify-start px-4">ğŸ” Google æ¤œç´¢ã§æ¢ã™</button>
                </div>
            </div>
            
            <div id="wikiContainer" class="hidden space-y-2">
                <div class="flex items-center justify-between">
                    <label id="labelWiki" class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Wikipedia æ¦‚è¦</label>
                    <a id="wikiLink" href="#" target="_blank" class="text-[10px] font-bold text-blue-500 hover:underline">ã‚‚ã£ã¨è¦‹ã‚‹</a>
                </div>
                <p id="wikiText" class="text-sm leading-relaxed text-gray-600 font-medium"></p>
            </div>

            <div id="quizSection" class="hidden bg-purple-50 p-6 rounded-3xl border border-purple-100 space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="bg-purple-600 text-white p-1.5 rounded-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <label id="labelQuiz" class="text-[10px] font-black text-purple-600 uppercase tracking-widest">AI ã‚¯ã‚¤ã‚º</label>
                    </div>
                    <button onclick="generateQuiz()" id="refreshQuizBtn" class="text-[10px] font-bold text-purple-400 hover:text-purple-600 transition-colors">åˆ¥ã®å•é¡Œ</button>
                </div>
                
                <div id="quizLoading" class="hidden py-4 flex flex-col items-center justify-center space-y-2">
                    <div class="w-6 h-6 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
                    <span id="quizLoadingText" class="text-[10px] font-bold text-purple-400 uppercase tracking-tighter text-center">AI ãŒã‚¯ã‚¤ã‚ºã‚’è€ƒãˆã¦ã„ã¾ã™...</span>
                </div>

                <div id="quizContent" class="space-y-4">
                    <p id="quizQuestion" class="text-sm font-bold text-purple-900 leading-relaxed"></p>
                    <div id="quizOptions" class="space-y-0"></div>
                </div>
            </div>

            <div id="tipSection" class="bg-blue-50/50 p-5 rounded-3xl border border-blue-100 flex items-start gap-3 overflow-hidden">
                <div class="bg-blue-600 text-white p-2 rounded-xl shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <div class="space-y-1">
                    <label id="labelTip" class="text-[10px] font-black text-blue-400 uppercase tracking-widest">æ¢ç´¢ã®ãƒ’ãƒ³ãƒˆ</label>
                    <div id="tipContainer"><p id="tipText" class="text-xs font-bold text-blue-900/70 leading-relaxed animate-tip"></p></div>
                </div>
            </div>

            <div id="linksSection" class="space-y-3 pt-4 border-t border-gray-100">
                <label id="labelLinks" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-1">å¤–éƒ¨ãƒªãƒ³ã‚¯ãƒ»é€£æº</label>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="navExternal('gmaps')" id="btnGmaps" class="action-btn active-base !justify-start px-4">ğŸ“ Google Maps ã§é–‹ã</button>
                    <button onclick="navExternal('directions')" id="btnDirections" class="action-btn !justify-start px-4">ğŸš— ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã‚’é–‹ã</button>
                    <button onclick="navExternal('reviews')" id="btnReviews" class="action-btn !justify-start px-4">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ã‚¯ãƒã‚³ãƒŸã‚’è¦‹ã‚‹</button>
                    <button id="streetviewBtn" onclick="navExternal('streetview')" class="action-btn !justify-start px-4">ğŸ™ï¸ ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã§é–‹ã</button>
                    <button id="weatherBtn" onclick="navExternal('weather')" class="action-btn !justify-start px-4">â˜€ï¸ <span id="weatherLabel">ã®å¤©æ°—</span></button>
                    <button onclick="navExternal('earth')" id="btnEarth" class="action-btn !justify-start px-4">ğŸŒ Google Earth ã§é–‹ã</button>
                    <button onclick="navExternal('search')" class="action-btn !justify-start px-4">ğŸ” <span id="searchLabel">ã“ã®å ´æ‰€ã«ã¤ã„ã¦æ¤œç´¢</span></button>
                    <button onclick="navExternal('gsi')" id="btnGsi" class="action-btn !justify-start px-4">ğŸ—¾ å›½åœŸåœ°ç†é™¢åœ°å›³</button>
                </div>
            </div>
        </div>
    </aside>

    <div id="layerMenu" class="glass-panel p-5 absolute top-24 right-6 z-[9999] hidden flex-col gap-5 w-80 rounded-3xl overflow-y-auto max-h-[75vh]">
        <div>
            <label id="labelLangHeader" class="text-[10px] font-black text-blue-500 uppercase tracking-widest block mb-3">Language / è¨€èªè¨­å®š</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="changeLanguage('ja')" id="lang-ja" class="action-btn active-base">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
                <button onclick="changeLanguage('en')" id="lang-en" class="action-btn">ğŸ‡ºğŸ‡¸ English</button>
                <button onclick="changeLanguage('zh')" id="lang-zh" class="action-btn">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
                <button onclick="changeLanguage('ko')" id="lang-ko" class="action-btn">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
            </div>
        </div>

        <div>
            <label id="labelBase" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">åŸºæœ¬åœ°å›³ - ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="changeBase('osm')" id="base-osm" class="action-btn active-base">ğŸ—ºï¸ æ¨™æº–</button>
                <button onclick="changeBase('roadmap')" id="base-roadmap" class="action-btn">ğŸš— é“è·¯åœ°å›³</button>
                <button onclick="changeBase('terrain')" id="base-terrain" class="action-btn">â›°ï¸ åœ°å½¢å›³</button>
                <button onclick="changeBase('english')" id="base-english" class="action-btn">ğŸ‡ºğŸ‡¸ è‹±èªåœ°å›³</button>
                <button onclick="changeBase('gsistd')" id="base-gsistd" class="action-btn">ğŸ—¾ åœ°ç†é™¢æ¨™æº–</button>
            </div>
        </div>
        <div>
            <label id="labelMono" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">ãƒ¢ãƒãƒˆãƒ¼ãƒ³ãƒ»ç‰¹æ®Š</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="changeBase('dark')" id="base-dark" class="action-btn">ğŸ•¶ï¸ ãƒ€ãƒ¼ã‚¯</button>
                <button onclick="changeBase('grayscale')" id="base-grayscale" class="action-btn">âšª ã‚°ãƒ¬ãƒ¼</button>
                <button onclick="changeBase('bw')" id="base-bw" class="action-btn">ğŸ ãƒ¢ãƒã‚¯ãƒ­</button>
                <button onclick="changeBase('lightgray')" id="base-lightgray" class="action-btn">âšª ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼</button>
            </div>
        </div>
        <div>
            <label id="labelCustom" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒ</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="changeBase('rader_blue')" id="base-rader_blue" class="action-btn">ğŸ“¡ ãƒ–ãƒ«ãƒ¼</button>
                <button onclick="changeBase('rader_dark')" id="base-rader_dark" class="action-btn">ğŸ›°ï¸ ãƒ€ãƒ¼ã‚¯</button>
            </div>
        </div>
        <div>
            <label id="labelSat" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">èˆªç©ºå†™çœŸ (Satellite)</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="changeBase('satellite_g')" id="base-satellite_g" class="action-btn">ğŸ›°ï¸ è¡›æ˜Ÿå†™çœŸ</button>
                <button onclick="changeBase('satellite_hybrid')" id="base-satellite_hybrid" class="action-btn">ğŸ·ï¸ ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰</button>
                <button onclick="changeBase('gsiortho')" id="base-gsiortho" class="action-btn">ğŸ“¸ åœ°ç†é™¢å†™çœŸ</button>
                <button onclick="changeBase('esri')" id="base-esri" class="action-btn">ğŸŒ Esriè¡›æ˜Ÿ</button>
            </div>
        </div>
        <div>
            <label id="labelOverlay" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">ãƒ‡ãƒ¼ã‚¿é‡ã­åˆã‚ã›</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="toggleOverlay('hybrid')" id="btn-hybrid" class="action-btn">ğŸ·ï¸ ãƒ©ãƒ™ãƒ«</button>
                <button onclick="toggleOverlay('traffic')" id="btn-traffic" class="action-btn">ğŸš¥ äº¤é€šçŠ¶æ³</button>
                <button onclick="toggleOverlay('transit')" id="btn-transit" class="action-btn">ğŸšƒ é‰„é“ç¶²</button>
                <button onclick="toggleOverlay('eez')" id="btn-eez" class="action-btn">ğŸš¢ çµŒæ¸ˆæ°´åŸŸ</button>
                <button onclick="toggleOverlay('terminator')" id="btn-terminator" class="action-btn">ğŸŒ˜ æ˜¼å¤œ</button>
                <button onclick="toggleOverlay('clock')" id="btn-clock" class="action-btn">ğŸ•’ ä¸–ç•Œæ™‚è¨ˆ</button>
        </div>
    </div>

    <script>
        const apiKey = "";
        let map, marker, currentLat, currentLng, currentLocationName, currentWikiText = "";
        const baseLayers = {};
        const overlays = {};
        let activeBaseId = 'osm';
        let tipInterval;
        let clockInterval;
        let terminatorInterval;
        let currentLang = 'ja';
        
        const MIN_ZOOM = 3;
        const MAX_ZOOM = 19;  
        
        const cities = [
            { name: {ja: "æ±äº¬", en: "Tokyo"}, tz: "Asia/Tokyo", lat: 35.6895, lng: 139.6917 },
            { name: {ja: "ã‚¢ãƒ³ã‚«ãƒ¬ãƒƒã‚¸", en: "Anchorage"}, tz: "America/Anchorage", lat: 61.2181, lng: -149.9003 },
            { name: {ja: "ã‚¸ãƒ¥ãƒãƒ¼", en: "Juneau"}, tz: "America/Juneau", lat: 58.3019, lng: -134.4197 },
            { name: {ja: "ãƒãƒ¼ãƒ ", en: "Nome"}, tz: "America/Nome", lat: 64.5011, lng: -165.4064 },
            { name: {ja: "ã‚·ãƒˆã‚«", en: "Sitka"}, tz: "America/Sitka", lat: 57.0531, lng: -135.3300 },
            { name: {ja: "ãƒ¤ã‚¯ã‚¿ãƒƒãƒˆ", en: "Yakutat"}, tz: "America/Yakutat", lat: 59.5469, lng: -139.7272 },
            { name: {ja: "ãƒ‰ãƒ¼ã‚½ãƒ³", en: "Dawson"}, tz: "America/Dawson", lat: 64.0600, lng: -139.4320 },
            { name: {ja: "ãƒ­ã‚µãƒ³ã‚¼ãƒ«ã‚¹", en: "Los Angeles"}, tz: "America/Los_Angeles", lat: 34.0522, lng: -118.2437 },
            { name: {ja: "ãƒ†ã‚£ãƒ•ã‚¡ãƒŠ", en: "Tijuana"}, tz: "America/Tijuana", lat: 32.5149, lng: -117.0382 },
            { name: {ja: "ãƒãƒ³ã‚¯ãƒ¼ãƒãƒ¼", en: "Vancouver"}, tz: "America/Vancouver", lat: 49.2827, lng: -123.1207 },
            { name: {ja: "ãƒ›ãƒ¯ã‚¤ãƒˆãƒ›ãƒ¼ã‚¹", en: "Whitehorse"}, tz: "America/Whitehorse", lat: 60.7212, lng: -135.0568 },
            { name: {ja: "ãƒœã‚¤ã‚·", en: "Boise"}, tz: "America/Boise", lat: 43.6150, lng: -116.2023 },
            { name: {ja: "ã‚±ãƒ³ãƒ–ãƒªãƒƒã‚¸ãƒ™ã‚¤", en: "Cambridge Bay"}, tz: "America/Cambridge_Bay", lat: 69.1164, lng: -105.0528 },
            { name: {ja: "ãƒãƒ¯ãƒ¯", en: "Chihuahua"}, tz: "America/Chihuahua", lat: 28.6330, lng: -106.0691 },
            { name: {ja: "ã‚¯ãƒ¬ã‚¹ãƒˆãƒ³", en: "Creston"}, tz: "America/Creston", lat: 49.0964, lng: -116.5133 },
            { name: {ja: "ãƒ‰ãƒ¼ã‚½ãƒ³ã‚¯ãƒªãƒ¼ã‚¯", en: "Dawson Creek"}, tz: "America/Dawson_Creek", lat: 55.7591, lng: -120.2377 },
            { name: {ja: "ãƒ‡ãƒ³ãƒãƒ¼", en: "Denver"}, tz: "America/Denver", lat: 39.7392, lng: -104.9903 },
            { name: {ja: "ã‚¨ãƒ‰ãƒ¢ãƒ³ãƒˆãƒ³", en: "Edmonton"}, tz: "America/Edmonton", lat: 53.5461, lng: -113.4938 },
            { name: {ja: "ã‚¨ãƒ«ãƒ¢ã‚·ãƒ¼ã‚¸ãƒ§", en: "Hermosillo"}, tz: "America/Hermosillo", lat: 29.0730, lng: -110.9559 },
            { name: {ja: "ã‚¤ãƒŒãƒ´ã‚£ã‚¯", en: "Inuvik"}, tz: "America/Inuvik", lat: 68.3607, lng: -133.7230 },
            { name: {ja: "ãƒã‚µãƒˆãƒ©ãƒ³", en: "Mazatlan"}, tz: "America/Mazatlan", lat: 23.2494, lng: -106.4111 },
            { name: {ja: "ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹", en: "Phoenix"}, tz: "America/Phoenix", lat: 33.4484, lng: -112.0740 },
            { name: {ja: "ã‚¤ã‚¨ãƒ­ãƒ¼ãƒŠã‚¤ãƒ•", en: "Yellowknife"}, tz: "America/Yellowknife", lat: 62.4540, lng: -114.3718 },
            { name: {ja: "ã‚·ã‚«ã‚´", en: "Chicago"}, tz: "America/Chicago", lat: 41.8781, lng: -87.6298 },
            { name: {ja: "ãƒ¡ãƒªãƒ€", en: "Merida"}, tz: "America/Merida", lat: 20.9674, lng: -89.5926 },
            { name: {ja: "ãƒ¢ãƒ³ãƒ†ãƒ¬ã‚¤", en: "Monterrey"}, tz: "America/Monterrey", lat: 25.6866, lng: -100.3161 },
            { name: {ja: "ãƒ¡ã‚­ã‚·ã‚³ã‚·ãƒ†ã‚£", en: "Mexico City"}, tz: "America/Mexico_City", lat: 19.4326, lng: -99.1332 },
            { name: {ja: "ã‚¦ã‚£ãƒ‹ãƒšã‚°", en: "Winnipeg"}, tz: "America/Winnipeg", lat: 49.8951, lng: -97.1384 },
            { name: {ja: "ãƒ¬ã‚¸ãƒ¼ãƒŠ", en: "Regina"}, tz: "America/Regina", lat: 50.4452, lng: -104.6189 },
            { name: {ja: "ãƒœã‚´ã‚¿", en: "Bogota"}, tz: "America/Bogota", lat: 4.7110, lng: -74.0721 },
            { name: {ja: "ã‚«ãƒ³ã‚¯ãƒ³", en: "Cancun"}, tz: "America/Cancun", lat: 21.1619, lng: -86.8515 },
            { name: {ja: "ãƒ‡ãƒˆãƒ­ã‚¤ãƒˆ", en: "Detroit"}, tz: "America/Detroit", lat: 42.3314, lng: -83.0458 },
            { name: {ja: "ãƒãƒãƒŠ", en: "Havana"}, tz: "America/Havana", lat: 23.1136, lng: -82.3666 },
            { name: {ja: "ãƒˆãƒ­ãƒ³ãƒˆ", en: "Toronto"}, tz: "America/Toronto", lat: 43.6532, lng: -79.3832 },
            { name: {ja: "ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯", en: "New York"}, tz: "America/New_York", lat: 40.7128, lng: -74.0060 },
            { name: {ja: "ãƒªãƒ", en: "Lima"}, tz: "America/Lima", lat: -12.0464, lng: -77.0428 },
            { name: {ja: "ã‚µãƒ³ãƒ†ã‚£ã‚¢ã‚´", en: "Santiago"}, tz: "America/Santiago", lat: -33.4489, lng: -70.6693 },
            { name: {ja: "ãƒ–ã‚¨ãƒã‚¹ã‚¢ã‚¤ãƒ¬ã‚¹", en: "Buenos Aires"}, tz: "America/Argentina/Buenos_Aires", lat: -34.6037, lng: -58.3816 },
            { name: {ja: "ãƒ¢ãƒ³ãƒ†ãƒ“ãƒ‡ã‚ª", en: "Montevideo"}, tz: "America/Montevideo", lat: -34.9011, lng: -56.1645 },
            { name: {ja: "ã‚µãƒ³ãƒ‘ã‚¦ãƒ­", en: "Sao Paulo"}, tz: "America/Sao_Paulo", lat: -23.5505, lng: -46.6333 },
            { name: {ja: "ãƒ–ãƒ©ã‚¸ãƒªã‚¢", en: "Brasilia"}, tz: "America/Sao_Paulo", lat: -15.7975, lng: -47.8919 },
            { name: {ja: "ãƒ­ãƒ³ãƒ‰ãƒ³", en: "Europe/London"}, tz: "Europe/London", lat: 51.5074, lng: -0.1278 },
            { name: {ja: "ãƒ€ãƒ–ãƒªãƒ³", en: "Dublin"}, tz: "Europe/Dublin", lat: 53.3498, lng: -6.2603 },
            { name: {ja: "ãƒªã‚¹ãƒœãƒ³", en: "Lisbon"}, tz: "Europe/Lisbon", lat: 38.7223, lng: -9.1393 },
            { name: {ja: "ãƒ¬ã‚¤ã‚­ãƒ£ãƒ“ã‚¯", en: "Reykjavik"}, tz: "Atlantic/Reykjavik", lat: 64.1466, lng: -21.9426 },
            { name: {ja: "ã‚¢ãƒ ã‚¹ãƒ†ãƒ«ãƒ€ãƒ ", en: "Amsterdam"}, tz: "Europe/Amsterdam", lat: 52.3676, lng: 4.9041 },
            { name: {ja: "ãƒ™ãƒ«ãƒªãƒ³", en: "Berlin"}, tz: "Europe/Berlin", lat: 52.5200, lng: 13.4050 },
            { name: {ja: "ãƒ‘ãƒª", en: "Paris"}, tz: "Europe/Paris", lat: 48.8566, lng: 2.3522 },
            { name: {ja: "ãƒ­ãƒ¼ãƒ", en: "Rome"}, tz: "Europe/Rome", lat: 41.9028, lng: 12.4964 },
            { name: {ja: "ãƒãƒ‰ãƒªãƒ¼ãƒ‰", en: "Madrid"}, tz: "Europe/Madrid", lat: 40.4168, lng: -3.7038 },
            { name: {ja: "ã‚¦ã‚£ãƒ¼ãƒ³", en: "Vienna"}, tz: "Europe/Vienna", lat: 48.2082, lng: 16.3738 },
            { name: {ja: "ãƒ—ãƒ©ãƒ", en: "Prague"}, tz: "Europe/Prague", lat: 50.0755, lng: 14.4378 },
            { name: {ja: "ãƒ¯ãƒ«ã‚·ãƒ£ãƒ¯", en: "Warsaw"}, tz: "Europe/Warsaw", lat: 52.2297, lng: 21.0122 },
            { name: {ja: "ãƒ–ãƒ€ãƒšã‚¹ãƒˆ", en: "Budapest"}, tz: "Europe/Budapest", lat: 47.4979, lng: 19.0402 },
            { name: {ja: "ã‚¹ãƒˆãƒƒã‚¯ãƒ›ãƒ«ãƒ ", en: "Stockholm"}, tz: "Europe/Stockholm", lat: 59.3293, lng: 18.0686 },
            { name: {ja: "ã‚ªã‚¹ãƒ­", en: "Oslo"}, tz: "Europe/Oslo", lat: 59.9139, lng: 10.7522 },
            { name: {ja: "ãƒ˜ãƒ«ã‚·ãƒ³ã‚­", en: "Helsinki"}, tz: "Europe/Helsinki", lat: 60.1699, lng: 24.9384 },
            { name: {ja: "ã‚¢ãƒ†ãƒ", en: "Athens"}, tz: "Europe/Athens", lat: 37.9838, lng: 23.7275 },
            { name: {ja: "ã‚¤ã‚¹ã‚¿ãƒ³ãƒ–ãƒ¼ãƒ«", en: "Istanbul"}, tz: "Europe/Istanbul", lat: 41.0082, lng: 28.9784 },
            { name: {ja: "ãƒŸãƒ³ã‚¹ã‚¯", en: "Minsk"}, tz: "Europe/Minsk", lat: 53.9006, lng: 27.5590 },
            { name: {ja: "ãƒ¢ã‚¹ã‚¯ãƒ¯", en: "Moscow"}, tz: "Europe/Moscow", lat: 55.7558, lng: 37.6173 },
            { name: {ja: "ãƒ†ãƒ˜ãƒ©ãƒ³", en: "Tehran"}, tz: "Asia/Tehran", lat: 35.6892, lng: 51.3890 },
            { name: {ja: "ãƒã‚°ãƒ€ãƒƒãƒ‰", en: "Baghdad"}, tz: "Asia/Baghdad", lat: 33.3152, lng: 44.3661 },
            { name: {ja: "ãƒªãƒ¤ãƒ‰", en: "Riyadh"}, tz: "Asia/Riyadh", lat: 24.7136, lng: 46.6753 },
            { name: {ja: "ãƒ‰ãƒ¼ãƒ", en: "Doha"}, tz: "Asia/Qatar", lat: 25.2854, lng: 51.5310 },
            { name: {ja: "ã‚¢ãƒ–ãƒ€ãƒ“", en: "Abu Dhabi"}, tz: "Asia/Dubai", lat: 24.4539, lng: 54.3773 },
            { name: {ja: "ãƒã‚¹ã‚«ãƒƒãƒˆ", en: "Muscat"}, tz: "Asia/Muscat", lat: 23.5859, lng: 58.4059 },
            { name: {ja: "ã‚«ãƒ–ãƒ¼ãƒ«", en: "Kabul"}, tz: "Asia/Kabul", lat: 34.5553, lng: 69.1771 },
            { name: {ja: "ã‚«ãƒ©ãƒ", en: "Karachi"}, tz: "Asia/Karachi", lat: 24.8607, lng: 67.0011 },
            { name: {ja: "ãƒ‡ãƒªãƒ¼", en: "Delhi"}, tz: "Asia/Kolkata", lat: 28.6139, lng: 77.2090 },
            { name: {ja: "ã‚³ãƒ«ã‚«ã‚¿", en: "Kolkata"}, tz: "Asia/Kolkata", lat: 22.5726, lng: 88.3639 },
            { name: {ja: "ã‚³ãƒ­ãƒ³ãƒœ", en: "Colombo"}, tz: "Asia/Colombo", lat: 6.9271, lng: 79.8612 },
            { name: {ja: "ã‚«ãƒˆãƒãƒ³ã‚º", en: "Kathmandu"}, tz: "Asia/Kathmandu", lat: 27.7172, lng: 85.3240 },
            { name: {ja: "ãƒ€ãƒƒã‚«", en: "Dhaka"}, tz: "Asia/Dhaka", lat: 23.8103, lng: 90.4125 },
            { name: {ja: "ãƒ¤ãƒ³ã‚´ãƒ³", en: "Yangon"}, tz: "Asia/Yangon", lat: 16.8661, lng: 96.1951 },
            { name: {ja: "ãƒãƒ³ã‚³ã‚¯", en: "Bangkok"}, tz: "Asia/Bangkok", lat: 13.7563, lng: 100.5018 },
            { name: {ja: "ãƒ—ãƒãƒ³ãƒšãƒ³", en: "Phnom Penh"}, tz: "Asia/Phnom_Penh", lat: 11.5564, lng: 104.9282 },
            { name: {ja: "ãƒ“ã‚¨ãƒ³ãƒãƒ£ãƒ³", en: "Vientiane"}, tz: "Asia/Vientiane", lat: 17.9757, lng: 102.6331 },
            { name: {ja: "ãƒãƒã‚¤", en: "Hanoi"}, tz: "Asia/Ho_Chi_Minh", lat: 21.0285, lng: 105.8542 },
            { name: {ja: "ã‚¸ãƒ£ã‚«ãƒ«ã‚¿", en: "Jakarta"}, tz: "Asia/Jakarta", lat: -6.2088, lng: 106.8456 },
            { name: {ja: "ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«", en: "Singapore"}, tz: "Asia/Singapore", lat: 1.3521, lng: 103.8198 },
            { name: {ja: "ã‚¯ã‚¢ãƒ©ãƒ«ãƒ³ãƒ—ãƒ¼ãƒ«", en: "Kuala Lumpur"}, tz: "Asia/Kuala_Lumpur", lat: 3.1390, lng: 101.6869 },
            { name: {ja: "ãƒãƒ‹ãƒ©", en: "Manila"}, tz: "Asia/Manila", lat: 14.5995, lng: 120.9842 },
            { name: {ja: "é¦™æ¸¯", en: "Hong Kong"}, tz: "Asia/Hong_Kong", lat: 22.3193, lng: 114.1694 },
            { name: {ja: "ãƒã‚«ã‚ª", en: "Macau"}, tz: "Asia/Macau", lat: 22.1987, lng: 113.5439 },
            { name: {ja: "ä¸Šæµ·", en: "Shanghai"}, tz: "Asia/Shanghai", lat: 31.2304, lng: 121.4737 },
            { name: {ja: "å°åŒ—", en: "Taipei"}, tz: "Asia/Taipei", lat: 25.0330, lng: 121.5654 },
            { name: {ja: "ã‚½ã‚¦ãƒ«", en: "Seoul"}, tz: "Asia/Seoul", lat: 37.5665, lng: 126.9780 },
            { name: {ja: "å¹³å£Œ", en: "Pyongyang"}, tz: "Asia/Pyongyang", lat: 39.0392, lng: 125.7625 },
            { name: {ja: "ã‚¦ãƒ©ãƒ³ãƒãƒ¼ãƒˆãƒ«", en: "Ulaanbaatar"}, tz: "Asia/Ulaanbaatar", lat: 47.8864, lng: 106.9057 },
            { name: {ja: "ãƒ‘ãƒ¼ã‚¹", en: "Perth"}, tz: "Australia/Perth", lat: -31.9505, lng: 115.8605 },
            { name: {ja: "ãƒ€ãƒ¼ã‚¦ã‚£ãƒ³", en: "Darwin"}, tz: "Australia/Darwin", lat: -12.4634, lng: 130.8456 },
            { name: {ja: "ãƒ–ãƒªã‚¹ãƒ™ãƒ³", en: "Brisbane"}, tz: "Australia/Brisbane", lat: -27.4698, lng: 153.0251 },
            { name: {ja: "ã‚·ãƒ‰ãƒ‹ãƒ¼", en: "Sydney"}, tz: "Australia/Sydney", lat: -33.8688, lng: 151.2093 },
            { name: {ja: "ãƒ¡ãƒ«ãƒœãƒ«ãƒ³", en: "Melbourne"}, tz: "Australia/Melbourne", lat: -37.8136, lng: 144.9631 },
            { name: {ja: "ãƒ›ãƒãƒ¼ãƒˆ", en: "Hobart"}, tz: "Australia/Hobart", lat: -42.8821, lng: 147.3272 },
            { name: {ja: "ã‚­ãƒ£ãƒ³ãƒ™ãƒ©", en: "Canberra"}, tz: "Australia/Canberra", lat: -35.2809, lng: 149.1300 },
            { name: {ja: "ã‚¦ã‚§ãƒªãƒ³ãƒˆãƒ³", en: "Wellington"}, tz: "Pacific/Auckland", lat: -41.2865, lng: 174.7762 },
            { name: {ja: "ã‚ªãƒ¼ã‚¯ãƒ©ãƒ³ãƒ‰", en: "Auckland"}, tz: "Pacific/Auckland", lat: -36.8485, lng: 174.7633 },
            { name: {ja: "ã‚°ã‚¢ãƒ ", en: "Guam"}, tz: "Pacific/Guam", lat: 13.4443, lng: 144.7937 },
            { name: {ja: "ã‚µã‚¤ãƒ‘ãƒ³", en: "Saipan"}, tz: "Pacific/Saipan", lat: 15.1777, lng: 145.7515 },
            { name: {ja: "ãƒãƒ¼ãƒˆãƒ¢ãƒ¬ã‚¹ãƒ“ãƒ¼", en: "Port Moresby"}, tz: "Pacific/Port_Moresby", lat: -9.4438, lng: 147.1803 },
            { name: {ja: "ãƒŒãƒ¡ã‚¢", en: "Noumea"}, tz: "Pacific/Noumea", lat: -22.2711, lng: 166.4416 },
            { name: {ja: "æ˜­å’ŒåŸºåœ°", en: "Syowa Station"}, tz: "Antarctica/Syowa", lat: -69.0042, lng: 39.5814 },
            { name: {ja: "ãƒŸãƒƒãƒ‰ã‚¦ã‚§ã‚¤", en: "Midway"}, tz: "Pacific/Midway", lat: 28.2101, lng: -177.3761 },
            { name: {ja: "ãƒ‹ã‚¦ã‚¨", en: "Niue"}, tz: "Pacific/Niue", lat: -19.0544, lng: -169.8672 },
            { name: {ja: "ãƒ‘ã‚´ãƒ‘ã‚´", en: "Pago Pago"}, tz: "Pacific/Pago_Pago", lat: -14.2781, lng: -170.7025 },
            { name: {ja: "ãƒ›ãƒãƒ«ãƒ«", en: "Honolulu"}, tz: "Pacific/Honolulu", lat: 21.3069, lng: -157.8583 },
            { name: {ja: "ãƒ©ãƒ­ãƒˆãƒ³ã‚¬", en: "Rarotonga"}, tz: "Pacific/Rarotonga", lat: -21.2367, lng: -159.7777 },
            { name: {ja: "ã‚¿ãƒ’ãƒ", en: "Tahiti"}, tz: "Pacific/Tahiti", lat: -17.6509, lng: -149.4260 },
            { name: {ja: "ãƒãƒ«ã‚±ã‚µã‚¹", en: "Marquesas"}, tz: "Pacific/Marquesas", lat: -9.1000, lng: -139.5000 },
            { name: {ja: "ã‚¬ãƒ³ãƒ“ã‚¨", en: "Gambier"}, tz: "Pacific/Gambier", lat: -23.1500, lng: -134.9667 },
            { name: {ja: "ãƒ”ãƒˆã‚±ã‚¢ãƒ³", en: "Pitcairn"}, tz: "Pacific/Pitcairn", lat: -25.0667, lng: -130.1000 },
            { name: {ja: "ã‚¬ãƒ©ãƒ‘ã‚´ã‚¹", en: "Galapagos"}, tz: "Pacific/Galapagos", lat: -0.7399, lng: -90.3518 },
            { name: {ja: "ã‚¤ãƒ¼ã‚¹ã‚¿ãƒ¼", en: "Easter"}, tz: "Pacific/Easter", lat: -27.1127, lng: -109.3497 },
            { name: {ja: "ãƒŠãƒƒã‚½ãƒ¼", en: "Nassau"}, tz: "America/Nassau", lat: 25.0443, lng: -77.3504 },
            { name: {ja: "ãƒãƒ«ãƒˆãƒ¼ãƒ—ãƒ©ãƒ³ã‚¹", en: "Port-au-Prince"}, tz: "America/Port-au-Prince", lat: 18.5392, lng: -72.3350 },
            { name: {ja: "ã‚«ãƒ©ã‚«ã‚¹", en: "Caracas"}, tz: "America/Caracas", lat: 10.4806, lng: -66.9036 },
            { name: {ja: "ã‚¢ã‚¹ãƒ³ã‚·ã‚ªãƒ³", en: "Asuncion"}, tz: "America/Asuncion", lat: -25.2637, lng: -57.5759 },
            { name: {ja: "ãƒ©ãƒ‘ã‚¹", en: "La Paz"}, tz: "America/La_Paz", lat: -16.4897, lng: -68.1193 },
            { name: {ja: "ã‚¢ãƒ³ã‚®ãƒ©", en: "Anguilla"}, tz: "America/Anguilla", lat: 18.2170, lng: -63.0578 },
            { name: {ja: "ã‚¢ãƒ³ãƒ†ã‚£ã‚°ã‚¢", en: "Antigua"}, tz: "America/Antigua", lat: 17.0608, lng: -61.7964 },
            { name: {ja: "ã‚¢ãƒ«ãƒ", en: "Aruba"}, tz: "America/Aruba", lat: 12.5211, lng: -69.9683 },
            { name: {ja: "ãƒãƒ«ãƒãƒ‰ã‚¹", en: "Barbados"}, tz: "America/Barbados", lat: 13.1939, lng: -59.5432 },
            { name: {ja: "ã‚­ãƒ¥ãƒ©ã‚½ãƒ¼", en: "Curacao"}, tz: "America/Curacao", lat: 12.1696, lng: -68.9900 },
            { name: {ja: "ãƒ‰ãƒŸãƒ‹ã‚«", en: "Dominica"}, tz: "America/Dominica", lat: 15.4150, lng: -61.3710 },
            { name: {ja: "ã‚°ãƒ¬ãƒŠãƒ€", en: "Grenada"}, tz: "America/Grenada", lat: 12.1165, lng: -61.6790 },
            { name: {ja: "ã‚°ã‚¢ãƒ‰ãƒ«ãƒ¼ãƒ—", en: "Guadeloupe"}, tz: "America/Guadeloupe", lat: 16.2650, lng: -61.5510 },
            { name: {ja: "ãƒãƒ«ãƒ†ã‚£ãƒ‹ãƒ¼ã‚¯", en: "Martinique"}, tz: "America/Martinique", lat: 14.6415, lng: -61.0242 },
            { name: {ja: "ãƒ¢ãƒ³ãƒˆã‚»ãƒ©ãƒˆ", en: "Montserrat"}, tz: "America/Montserrat", lat: 16.7425, lng: -62.1873 },
            { name: {ja: "ãƒ—ã‚¨ãƒ«ãƒˆãƒªã‚³", en: "Puerto Rico"}, tz: "America/Puerto_Rico", lat: 18.2208, lng: -66.5901 },
            { name: {ja: "ã‚»ãƒ³ãƒˆãƒ»ãƒãƒ«ãƒ†ãƒ«ãƒŸãƒ¼", en: "St. Barthelemy"}, tz: "America/St_Barthelemy", lat: 17.9000, lng: -62.8333 },
            { name: {ja: "ã‚»ãƒ³ãƒˆã‚­ãƒƒãƒ„", en: "St. Kitts"}, tz: "America/St_Kitts", lat: 17.3578, lng: -62.7830 },
            { name: {ja: "ã‚»ãƒ³ãƒˆãƒ«ã‚·ã‚¢", en: "St. Lucia"}, tz: "America/St_Lucia", lat: 13.9094, lng: -60.9789 },
            { name: {ja: "ã‚»ãƒ³ãƒˆãƒ“ãƒ³ã‚»ãƒ³ãƒˆ", en: "St. Vincent"}, tz: "America/St_Vincent", lat: 13.2528, lng: -61.1970 },
            { name: {ja: "ãƒˆãƒ«ãƒˆãƒ©", en: "Tortola"}, tz: "America/Tortola", lat: 18.4314, lng: -64.6231 },
            { name: {ja: "ãƒãƒŸãƒ¥ãƒ¼ãƒ€", en: "Bermuda"}, tz: "Atlantic/Bermuda", lat: 32.3078, lng: -64.7505 },
            { name: {ja: "ãƒãƒ­ãƒ¼ãƒ‹ãƒ£", en: "Noronha"}, tz: "America/Noronha", lat: -3.8548, lng: -32.4231 },
            { name: {ja: "ã‚µã‚¦ã‚¹ã‚¸ãƒ§ãƒ¼ã‚¸ã‚¢", en: "South Georgia"}, tz: "Atlantic/South_Georgia", lat: -54.2811, lng: -36.5084 },
            { name: {ja: "ã‚¢ã‚¾ãƒ¬ã‚¹", en: "Azores"}, tz: "Atlantic/Azores", lat: 37.7412, lng: -25.6756 },
            { name: {ja: "ã‚«ãƒ¼ãƒœãƒ™ãƒ«ãƒ‡", en: "Cape Verde"}, tz: "Atlantic/Cape_Verde", lat: 14.9177, lng: -23.5092 },
            { name: {ja: "ãƒ•ã‚§ãƒ­ãƒ¼è«¸å³¶", en: "Faroe"}, tz: "Atlantic/Faroe", lat: 62.0078, lng: -6.7771 },
            { name: {ja: "ãƒãƒ‡ã‚¤ãƒ©", en: "Madeira"}, tz: "Atlantic/Madeira", lat: 32.7607, lng: -16.9595 },
            { name: {ja: "ãƒãƒ³å³¶", en: "Isle of Man"}, tz: "Europe/Isle_of_Man", lat: 54.2361, lng: -4.5481 },
            { name: {ja: "ã‚¸ãƒ£ãƒ¼ã‚¸ãƒ¼", en: "Jersey"}, tz: "Europe/Jersey", lat: 49.2144, lng: -2.1312 },
            { name: {ja: "ã‚¬ãƒ¼ãƒ³ã‚¸ãƒ¼", en: "Guernsey"}, tz: "Europe/Guernsey", lat: 49.4482, lng: -2.5895 },
            { name: {ja: "ã‚³ãƒ¢ãƒ­", en: "Comoro"}, tz: "Indian/Comoro", lat: -11.6455, lng: 43.3333 },
            { name: {ja: "ãƒãƒ¨ãƒƒãƒˆ", en: "Mayotte"}, tz: "Indian/Mayotte", lat: -12.8275, lng: 45.1662 },
            { name: {ja: "ãƒãƒ˜", en: "Mahe"}, tz: "Indian/Mahe", lat: -4.6796, lng: 55.4920 },
            { name: {ja: "ãƒ¢ãƒ¼ãƒªã‚·ãƒ£ã‚¹", en: "Mauritius"}, tz: "Indian/Mauritius", lat: -20.3484, lng: 57.5522 },
            { name: {ja: "ãƒ¬ãƒ¦ãƒ‹ã‚ªãƒ³", en: "Reunion"}, tz: "Indian/Reunion", lat: -20.8820, lng: 55.4507 },
            { name: {ja: "ã‚±ãƒ«ã‚²ãƒ¬ãƒ³", en: "Kerguelen"}, tz: "Indian/Kerguelen", lat: -49.3500, lng: 70.2167 },
            { name: {ja: "ãƒ¢ãƒ«ãƒ‡ã‚£ãƒ–", en: "Maldives"}, tz: "Indian/Maldives", lat: 4.1755, lng: 73.5093 },
            { name: {ja: "ãƒãƒ£ã‚´ã‚¹", en: "Chagos"}, tz: "Indian/Chagos", lat: -7.3111, lng: 72.4222 },
            { name: {ja: "ã‚³ã‚³ã‚¹", en: "Cocos"}, tz: "Indian/Cocos", lat: -12.1642, lng: 96.8710 },
            { name: {ja: "ã‚¯ãƒªã‚¹ãƒã‚¹", en: "Christmas"}, tz: "Indian/Christmas", lat: -10.4475, lng: 105.6904 },
            { name: {ja: "ãƒ‘ãƒ©ã‚ª", en: "Palau"}, tz: "Pacific/Palau", lat: 7.3508, lng: 134.4826 },
            { name: {ja: "ãƒãƒ¥ãƒ¼ã‚¯", en: "Chuuk"}, tz: "Pacific/Chuuk", lat: 7.4467, lng: 151.8470 },
            { name: {ja: "ã‚³ã‚¹ãƒ©ã‚¨", en: "Kosrae"}, tz: "Pacific/Kosrae", lat: 5.3167, lng: 162.9833 },
            { name: {ja: "ãƒãƒ³ãƒšã‚¤", en: "Pohnpei"}, tz: "Pacific/Pohnpei", lat: 6.9167, lng: 158.2167 },
            { name: {ja: "ãƒãƒ¼ãƒ•ã‚©ãƒ¼ã‚¯", en: "Norfolk"}, tz: "Pacific/Norfolk", lat: -29.0333, lng: 167.9500 },
            { name: {ja: "ãƒ–ãƒ¼ã‚²ãƒ³ãƒ“ãƒ«", en: "Bougainville"}, tz: "Pacific/Bougainville", lat: -6.2640, lng: 155.5610 },
            { name: {ja: "ã‚¨ãƒ•ã‚¡ãƒ†", en: "Efate"}, tz: "Pacific/Efate", lat: -17.7130, lng: 168.4410 },
            { name: {ja: "ã‚¬ãƒ€ãƒ«ã‚«ãƒŠãƒ«", en: "Guadalcanal"}, tz: "Pacific/Guadalcanal", lat: -9.5772, lng: 160.1456 },
            { name: {ja: "ãƒ•ãƒŠãƒ•ãƒ†ã‚£", en: "Funafuti"}, tz: "Pacific/Funafuti", lat: -8.5208, lng: 179.1962 },
            { name: {ja: "ã‚¯ã‚§ã‚¼ãƒªãƒ³", en: "Kwajalein"}, tz: "Pacific/Kwajalein", lat: 8.7167, lng: 167.7333 },
            { name: {ja: "ãƒã‚¸ãƒ¥ãƒ­", en: "Majuro"}, tz: "Pacific/Majuro", lat: 7.1167, lng: 171.3667 },
            { name: {ja: "ãƒŠã‚¦ãƒ«", en: "Nauru"}, tz: "Pacific/Nauru", lat: -0.5228, lng: 166.9315 },
            { name: {ja: "ã‚¿ãƒ©ãƒ¯", en: "Tarawa"}, tz: "Pacific/Tarawa", lat: 1.3333, lng: 173.0000 },
            { name: {ja: "ã‚¦ã‚§ã‚¤ã‚¯", en: "Wake"}, tz: "Pacific/Wake", lat: 19.2833, lng: 166.6167 },
            { name: {ja: "ãƒ¯ãƒªã‚¹", en: "Wallis"}, tz: "Pacific/Wallis", lat: -13.3000, lng: -176.2000 },
            { name: {ja: "ã‚¨ãƒ³ãƒ€ãƒ™ãƒªãƒ¼", en: "Enderbury"}, tz: "Pacific/Enderbury", lat: -3.1333, lng: -171.0833 },
            { name: {ja: "ãƒ•ã‚¡ã‚«ã‚ªãƒ•ã‚©", en: "Fakaofo"}, tz: "Pacific/Fakaofo", lat: -9.3803, lng: -171.2189 },
            { name: {ja: "ãƒ•ã‚£ã‚¸ãƒ¼", en: "Fiji"}, tz: "Pacific/Fiji", lat: -18.1416, lng: 178.4419 },
            { name: {ja: "ãƒˆãƒ³ã‚¬ã‚¿ãƒ—", en: "Tongatapu"}, tz: "Pacific/Tongatapu", lat: -21.1667, lng: -175.2000 },
            { name: {ja: "ãƒãƒ£ã‚¿ãƒ ", en: "Chatham"}, tz: "Pacific/Chatham", lat: -43.9167, lng: -176.5000 },
            { name: {ja: "ã‚¢ãƒ”ã‚¢", en: "Apia"}, tz: "Pacific/Apia", lat: -13.8333, lng: -171.7667 },
            { name: {ja: "ã‚­ãƒªãƒ†ã‚£ãƒãƒ†ã‚£", en: "Kiritimati"}, tz: "Pacific/Kiritimati", lat: 1.8888, lng: -157.4333 },
            { name: {ja: "ãƒ¯ã‚·ãƒ³ãƒˆãƒ³D.C.", en: "Washington D.C."}, tz: "America/New_York", lat: 38.9072, lng: -77.0369 },
            { name: {ja: "ã‚ªã‚¿ãƒ¯", en: "Ottawa"}, tz: "America/Toronto", lat: 45.4215, lng: -75.6972 },
            { name: {ja: "ã‚¢ãƒ¡ãƒªã‚«", en: "USA"}, tz: "America/Chicago", lat: 37.0902, lng: -95.7129 },
            { name: {ja: "å¤ªå¹³æ´‹", en: "Pacific Ocean"}, tz: "UTC", lat: 0, lng: -160 },
            { name: {ja: "å¤§è¥¿æ´‹", en: "Atlantic Ocean"}, tz: "UTC", lat: 0, lng: -30 },
            { name: {ja: "ã‚¢ãƒ•ãƒªã‚«", en: "Africa"}, tz: "Africa/Nairobi", lat: -0.0236, lng: 37.9062 },
            { name: {ja: "ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘", en: "Europe"}, tz: "Europe/Berlin", lat: 54.5260, lng: 15.2551 },
            { name: {ja: "ã‚¢ã‚¸ã‚¢", en: "Asia"}, tz: "Asia/Shanghai", lat: 34.0479, lng: 100.6197 },
            { name: {ja: "ã‚¤ãƒ³ãƒ‰æ´‹", en: "Indian Ocean"}, tz: "UTC", lat: -20, lng: 80 },
            { name: {ja: "ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢", en: "Australia Continent"}, tz: "Australia/Sydney", lat: -25.2744, lng: 133.7751 },
            { name: {ja: "å—æ¥µå¤§é™¸", en: "Antarctica"}, tz: "Antarctica/South_Pole", lat: -90, lng: 0 },
            { name: {ja: "åŒ—æ¥µ", en: "Arctic"}, tz: "UTC", lat: 90, lng: 0 },
            { name: {ja: "ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³", en: "Argentina"}, tz: "America/Argentina/Buenos_Aires", lat: -38.4161, lng: -63.6167 },
            { name: {ja: "ã‚¤ãƒ³ãƒ‡ã‚£ã‚¢ãƒŠ", en: "Indiana"}, tz: "America/Indiana/Indianapolis", lat: 39.7684, lng: -86.1581 },
            { name: {ja: "ã‚±ãƒ³ã‚¿ãƒƒã‚­ãƒ¼", en: "Kentucky"}, tz: "America/Kentucky/Louisville", lat: 38.2527, lng: -85.7585 },
            { name: {ja: "ãƒãƒ¼ã‚¹ãƒ€ã‚³ã‚¿", en: "North Dakota"}, tz: "America/North_Dakota/Beulah", lat: 47.2692, lng: -101.7813 },
            { name: {ja: "UTC", en: "UTC"}, tz: "UTC", lat: 0, lng: 0 }
        ];

        function init() {
            if (typeof L === 'undefined') return;
            map = L.map('map', { 
                center: [35.6812, 139.7671], 
                zoom: 5, 
                minZoom: MIN_ZOOM,    
                maxZoom: MAX_ZOOM,    
                zoomControl: true, 
                attributionControl: false,
                worldCopyJump: true,
                maxBounds: [[-85, -500], [85, 500]],
                maxBoundsViscosity: 0.1
            });
            map.zoomControl.setPosition('bottomright');
            L.control.scale({ imperial: false, metric: true, position: 'bottomleft' }).addTo(map);

            const tileOptions = { minZoom: MIN_ZOOM, maxZoom: MAX_ZOOM, noWrap: false };
            baseLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', tileOptions);
            baseLayers.english = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', tileOptions);
            baseLayers.gsistd = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', tileOptions);
            baseLayers.gsiortho = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', tileOptions);
            baseLayers.dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', tileOptions);
            baseLayers.lightgray = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', tileOptions);
            baseLayers.esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', tileOptions);
            baseLayers.terrain = L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', tileOptions);
            baseLayers.roadmap = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', tileOptions);
            baseLayers.grayscale = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { ...tileOptions, className: 'filter-grayscale' });
            baseLayers.bw = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { ...tileOptions, className: 'filter-bw' });
            baseLayers.rader_blue = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { ...tileOptions, className: 'filter-rader-blue' });
            baseLayers.rader_dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', tileOptions);
            baseLayers.satellite_g = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', tileOptions);
            baseLayers.satellite_hybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', tileOptions);

            overlays.hybrid = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { zIndex: 1000, ...tileOptions });
            overlays.traffic = L.tileLayer('https://mt1.google.com/vt?lyrs=h@159000000,traffic|seconds_into_week:-1&style=3&x={x}&y={y}&z={z}', { zIndex: 900, opacity: 0.8, ...tileOptions });
            overlays.transit = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', { zIndex: 920, ...tileOptions });
            overlays.eez = L.tileLayer('https://geo.vliz.be/geoserver/gwc/service/tms/1.0.0/MarineRegions%3Aeez@EPSG%3A900913@png/{z}/{x}/{y}.png', { zIndex: 930, opacity: 0.6, tms: true, ...tileOptions });
            
            if (typeof L.terminator === 'function') overlays.terminator = L.terminator({ fillOpacity: 0.4, color: '#000814', zIndex: 950 });
            overlays.clock = L.layerGroup(); 
            
            // Initialize map with OSM. Labels (overlays.hybrid) are NOT added by default.
            baseLayers.osm.addTo(map);

            map.on('click', e => updateUI(e.latlng.lat, e.latlng.lng));
            startTipRotation();
            applyUITranslation();
        }

        // ... uiTranslations ...
        const uiTranslations = {
            ja: {
                searchPlaceholder: "å ´æ‰€ã‚’æ¤œç´¢...",
                poiDefault: "å ´æ‰€ã‚’é¸æŠ",
                labelAddr: "ğŸ“ ä½æ‰€",
                labelWiki: "Wikipedia æ¦‚è¦",
                labelWikiMore: "ã‚‚ã£ã¨è¦‹ã‚‹",
                labelQuiz: "AI ã‚¯ã‚¤ã‚º",
                btnRefreshQuiz: "åˆ¥ã®å•é¡Œ",
                quizLoading: "AI ãŒã‚¯ã‚¤ã‚ºã‚’è€ƒãˆã¦ã„ã¾ã™...",
                labelTip: "æ¢ç´¢ã®ãƒ’ãƒ³ãƒˆ",
                labelLinks: "å¤–éƒ¨ãƒªãƒ³ã‚¯ãƒ»é€£æº",
                btnGmaps: "ğŸ“ Google ãƒãƒƒãƒ— ã§é–‹ã",
                btnDirections: "ğŸš— ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã‚’é–‹ã",
                btnReviews: "â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ã‚¯ãƒã‚³ãƒŸã‚’è¦‹ã‚‹",
                btnStreetView: "ğŸ™ï¸ ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã§é–‹ã",
                btnEarth: "ğŸŒ Google Earth ã§é–‹ã",
                btnGsi: "ğŸ—¾ å›½åœŸåœ°ç†é™¢åœ°å›³",
                weatherSuffix: "ã®å¤©æ°—",
                searchPrefix: "ã“ã®å ´æ‰€ã«ã¤ã„ã¦æ¤œç´¢",
                notFoundMsg: "æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«èª¤å­—ã‚„è„±å­—ãŒãªã„ã‹ã”ç¢ºèªãã ã•ã„ã€‚",
                btnSearchGoogle: "ğŸ” Google æ¤œç´¢ã§æ¢ã™",
                labelBase: "åŸºæœ¬åœ°å›³ - ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰",
                labelMono: "ãƒ¢ãƒãƒˆãƒ¼ãƒ³ãƒ»ç‰¹æ®Š",
                labelCustom: "ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒ",
                labelSat: "èˆªç©ºå†™çœŸ (Satellite)",
                labelOverlay: "ãƒ‡ãƒ¼ã‚¿é‡ã­åˆã‚ã›",
                wikiLoader: "Wikipediaã‚’æ¤œç´¢ä¸­...",
                noWikiImage: "Wikipediaç”»åƒãªã—",
                labelLangHeader: "Language / è¨€èªè¨­å®š",
                base_osm: "ğŸ—ºï¸ æ¨™æº–",
                base_roadmap: "ğŸš— é“è·¯åœ°å›³",
                base_terrain: "â›°ï¸ åœ°å½¢å›³",
                base_english: "ğŸ‡ºğŸ‡¸ English",
                base_gsistd: "ğŸ—¾ åœ°ç†é™¢æ¨™æº–",
                base_dark: "ğŸ•¶ï¸ ãƒ€ãƒ¼ã‚¯",
                base_grayscale: "âšª ã‚°ãƒ¬ãƒ¼",
                base_bw: "ğŸ ãƒ¢ãƒã‚¯ãƒ­",
                base_lightgray: "âšª ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼",
                base_rader_blue: "ğŸ“¡ ãƒ–ãƒ«ãƒ¼",
                base_rader_dark: "ğŸ›°ï¸ ãƒ€ãƒ¼ã‚¯",
                base_satellite_g: "ğŸ›°ï¸ è¡›æ˜Ÿå†™çœŸ",
                base_satellite_hybrid: "ğŸ·ï¸ ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰",
                base_gsiortho: "ğŸ“¸ åœ°ç†é™¢å†™çœŸ",
                base_esri: "ğŸŒ Esriè¡›æ˜Ÿ",
                btn_hybrid: "ğŸ·ï¸ ãƒ©ãƒ™ãƒ«",
                btn_traffic: "ğŸš¥ äº¤é€šçŠ¶æ³",
                btn_transit: "ğŸšƒ é‰„é“ç¶²",
                btn_eez: "ğŸš¢ æ’ä»–çš„çµŒæ¸ˆæ°´åŸŸï¼ˆEEZï¼‰",
                btn_terminator: "ğŸŒ˜ æ˜¼å¤œãƒ©ã‚¤ãƒ³",
                btn_clock: "ğŸ•’ ä¸–ç•Œæ™‚è¨ˆ",
                explanation: "è§£èª¬",
                legendTitle: "å‡¡ä¾‹", 
                leg_fast: "é †èª¿", leg_slow: "æ··é›‘", leg_jam: "æ¸‹æ»", leg_rail: "é‰„é“è·¯ç·š", 
                leg_eez: "æ’ä»–çš„çµŒæ¸ˆæ°´åŸŸ", leg_night: "å¤œé–“",
                tips: [
                    "åœ°å›³ä¸Šã®ã©ã“ã‹ã‚’ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®å ´æ‰€ã®æƒ…å ±ã‚’ç¬æ™‚ã«å–å¾—ã§ãã¾ã™ã€‚",
                    "ã€Œãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€å›½åœŸåœ°ç†é™¢ã®åœ°å½¢å›³ã‚„Esriã®è¡›æ˜Ÿå†™çœŸã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚",
                    "æ¤œç´¢ã§å ´æ‰€ãŒè¦‹ã¤ã‹ã‚‰ãªã„æ™‚ã¯ã€å¸‚åŒºç”ºæ‘åã‚’è¿½åŠ ã™ã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚",
                    "ã€Œãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ã‚ªãƒ³ã«ã™ã‚‹ã¨ã€é“è·¯åã€æµ·ã€å·ã€å±±è„ˆåãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚",
                    "é‰„é“ç¶²ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¡¨ç¤ºã™ã‚Œã°ã€æœ€å¯„ã‚Šé§…ã‚„è·¯ç·šã®ã¤ãªãŒã‚Šã‚’ä¸€ç›®ã§ç¢ºèªã§ãã¾ã™ã€‚",
                    "Wikipediaã®æ¦‚è¦ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®å ´æ‰€ã®è©³ç´°ãªæ­´å²ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚",
                    "æ˜¼å¤œãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤ºã™ã‚Œã°ã€ç¾åœ¨ä¸–ç•Œã®ã©ã“ãŒå¤œãªã®ã‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã§ãã¾ã™ã€‚",
                    "ã€ŒçµŒæ¸ˆæ°´åŸŸ (EEZ)ã€ã‚’ã‚ªãƒ³ã«ã™ã‚‹ã¨ã€å„å›½ã®æ’ä»–çš„çµŒæ¸ˆæ°´åŸŸã®å¢ƒç•Œç·šãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"
                ]
            },
            en: {
                searchPlaceholder: "Search locations...",
                poiDefault: "Select a Place",
                labelAddr: "ğŸ“ Address",
                labelWiki: "Wikipedia Summary",
                labelWikiMore: "See more",
                labelQuiz: "AI Quiz",
                btnRefreshQuiz: "New Quiz",
                quizLoading: "AI is thinking...",
                labelTip: "Explorer Tips",
                labelLinks: "External Links",
                btnGmaps: "ğŸ“ Open in Google Maps",
                btnDirections: "ğŸš— Directions",
                btnReviews: "â­ Reviews",
                btnStreetView: "ğŸ™ï¸ Street View",
                btnEarth: "ğŸŒ Google Earth",
                btnGsi: "ğŸ—¾ GSI Map (Japan)",
                weatherSuffix: " Weather",
                searchPrefix: "Search about this place",
                notFoundMsg: "Please check your spelling or try another keyword.",
                btnSearchGoogle: "ğŸ” Search on Google",
                labelBase: "Base Maps - Standard",
                labelMono: "Monotone & Special",
                labelCustom: "Custom Themes",
                labelSat: "Satellite Imagery",
                labelOverlay: "Data Overlays",
                wikiLoader: "Searching Wikipedia...",
                noWikiImage: "No Wikipedia Image",
                labelLangHeader: "Language Settings",
                base_osm: "ğŸ—ºï¸ Standard",
                base_roadmap: "ğŸš— Road Map",
                base_terrain: "â›°ï¸ Terrain",
                base_english: "ğŸ‡ºğŸ‡¸ English Map",
                base_gsistd: "ğŸ—¾ GSI Std",
                base_dark: "ğŸ•¶ï¸ Dark",
                base_grayscale: "âšª Gray",
                base_bw: "ğŸ B&W",
                base_lightgray: "âšª Light Gray",
                base_rader_blue: "ğŸ“¡ Blue",
                base_rader_dark: "ğŸ›°ï¸ Dark",
                base_satellite_g: "ğŸ›°ï¸ Satellite",
                base_satellite_hybrid: "ğŸ·ï¸ Hybrid",
                base_gsiortho: "ğŸ“¸ GSI Ortho",
                base_esri: "ğŸŒ Esri Satellite",
                btn_hybrid: "ğŸ·ï¸ Labels",
                btn_traffic: "ğŸš¥ Traffic",
                btn_transit: "ğŸšƒ Transit",
                btn_eez: "ğŸš¢ EEZ",
                btn_terminator: "ğŸŒ˜ Day and Night Line",
                btn_clock: "ğŸ•’ World Clock and Date",
                explanation: "Explanation",
                legendTitle: "Legend", 
                leg_fast: "Fast", leg_slow: "Slow", leg_jam: "Traffic Jam", leg_rail: "Railway", 
                leg_eez: "EEZ Boundary", leg_night: "Night",
                tips: [
                    "Click anywhere on the map to instantly get information about that location.",
                    "Switch to GSI topographic maps or Esri satellite imagery from the Layers button.",
                    "If a place isn't found, try adding the city or prefecture name for better accuracy.",
                    "Turn on the 'Hybrid' overlay to display road names, oceans, rivers and mountains.",
                    "Enable the 'Transit' layer to see nearby stations and railway connections.",
                    "Click the Wikipedia summary to learn about the history of the location.",
                    "Show the 'Day/Night' line to see which parts of the world are currently in darkness.",
                    "The 'EEZ' overlay shows the boundaries of Exclusive Economic Zones."
                ]
            },
            zh: {
                searchPlaceholder: "æœç´¢åœ°ç‚¹...",
                poiDefault: "é€‰æ‹©åœ°ç‚¹",
                labelAddr: "ğŸ“ åœ°å€",
                labelWiki: "ç»´åŸºç™¾ç§‘æ‘˜è¦",
                labelWikiMore: "æŸ¥çœ‹æ›´å¤š",
                labelQuiz: "äººå·¥æ™ºèƒ½æµ‹éªŒ",
                btnRefreshQuiz: "å¦ä¸€ä¸ªé—®é¢˜",
                quizLoading: "AIæ­£åœ¨æ€è€ƒ...",
                labelTip: "æ¢ç´¢æç¤º",
                labelLinks: "å¤–éƒ¨é“¾æ¥",
                btnGmaps: "ğŸ“ åœ¨ Google åœ°å›¾ä¸Šæ‰“å¼€",
                btnDirections: "ğŸš— è·¯çº¿æœç´¢",
                btnReviews: "â­ æŸ¥çœ‹è¯„è®º",
                btnStreetView: "ğŸ™ï¸ è¡—æ™¯",
                btnEarth: "ğŸŒ åœ¨ Google åœ°çƒä¸­æ‰“å¼€",
                btnGsi: "ğŸ—¾ æ—¥æœ¬å›½åœŸåœ°ç†é™¢åœ°å›¾",
                weatherSuffix: "çš„å¤©æ°”",
                searchPrefix: "æœç´¢å…³äºæ­¤åœ°ç‚¹çš„ä¿¡æ¯",
                notFoundMsg: "è¯·æ£€æŸ¥æ‹¼å†™æˆ–å°è¯•å…¶ä»–å…³é”®è¯ã€‚",
                btnSearchGoogle: "ğŸ” åœ¨ Google ä¸Šæœç´¢",
                labelBase: "åŸºæœ¬åœ°å›¾ - æ ‡å‡†",
                labelMono: "å•è‰²/ç‰¹æ®Š",
                labelCustom: "è‡ªå®šä¹‰ä¸»é¢˜",
                labelSat: "å«æ˜Ÿå›¾åƒ",
                labelOverlay: "æ•°æ®å åŠ ",
                wikiLoader: "æ­£åœ¨æœç´¢ç»´åŸºç™¾ç§‘...",
                noWikiImage: "æ— ç»´åŸºç™¾ç§‘å›¾ç‰‡",
                labelLangHeader: "è¯­è¨€è®¾ç½®",
                base_osm: "ğŸ—ºï¸ æ ‡å‡†",
                base_roadmap: "ğŸš— è·¯çº¿å›¾",
                base_terrain: "â›°ï¸ åœ°å½¢å›¾",
                base_english: "ğŸ‡ºğŸ‡¸ è‹±è¯­åœ°å›¾",
                base_gsistd: "ğŸ—¾ åœ°ç†é™¢æ ‡å‡†",
                base_dark: "ğŸ•¶ï¸ æ·±è‰²",
                base_grayscale: "âšª ç°è‰²",
                base_bw: "ğŸ é»‘ç™½",
                base_lightgray: "âšª æµ…ç°è‰²",
                base_rader_blue: "ğŸ“¡ è“è‰²é›·è¾¾",
                base_rader_dark: "ğŸ›°ï¸ æ·±è‰²é›·è¾¾",
                base_satellite_g: "ğŸ›°ï¸ å«æ˜Ÿç…§ç‰‡",
                base_satellite_hybrid: "ğŸ·ï¸ æ··åˆå›¾",
                base_gsiortho: "ğŸ“¸ åœ°ç†é™¢èˆªæ‹",
                base_esri: "ğŸŒ Esri å«æ˜Ÿ",
                btn_hybrid: "ğŸ·ï¸ æ ‡ç­¾",
                btn_traffic: "ğŸš¥ äº¤é€šçŠ¶å†µ",
                btn_transit: "ğŸšƒ é“è·¯ç½‘",
                btn_eez: "ğŸš¢ ä¸“å±ç»æµåŒºï¼ˆEEZï¼‰",
                btn_terminator: "ğŸŒ˜ æ—¥å¤œçº¿",
                btn_clock: "ğŸ•’ ä¸–ç•Œæ—¶é’Ÿå’Œæ—¥æœŸ",
                legendTitle: "å›¾ä¾‹", 
                leg_fast: "é€šç•…", leg_slow: "ç¹å¿™", leg_jam: "æ‹¥å µ", leg_rail: "é“è·¯çº¿", 
                leg_eez: "ä¸“å±ç»æµåŒº", leg_night: "å¤œé—´",
                tips: ["ç‚¹å‡»åœ°å›¾ä¸Šçš„ä»»ä½•åœ°æ–¹å³å¯è·å–è¯¥åœ°ç‚¹çš„ä¿¡æ¯ã€‚"]
            },
            ko: {
                searchPlaceholder: "ì¥ì†Œ ê²€ìƒ‰...",
                poiDefault: "ì¥æ‰€ ì„ íƒ",
                labelAddr: "ğŸ“ ì£¼ì†Œ",
                labelWiki: "ìœ„í‚¤ë°±ê³¼ ìš”ì•½",
                labelWikiMore: "ë” ë³´ê¸°",
                labelQuiz: "AI í€´ì¦ˆ",
                btnRefreshQuiz: "ë‹¤ë¥¸ ë¬¸ì œ",
                quizLoading: "AIê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤...",
                labelTip: "íƒìƒ‰ íŒ",
                labelLinks: "ì™¸ë¶€ ë§í¬",
                btnGmaps: "ğŸ“ Google ì§€ë„ì—ì„œ ì—´ê¸°",
                btnDirections: "ğŸš— ê²½ë¡œ ê²€ìƒ‰",
                btnReviews: "â­ ë¦¬ë·° ë³´ê¸°",
                btnStreetView: "ğŸ™ï¸ ìŠ¤íŠ¸ë¦¬íŠ¸ ë·°",
                btnEarth: "ğŸŒ Google ì–´ìŠ¤ì—ì„œ ì—´ê¸°",
                btnGsi: "ğŸ—¾ ì¼ë³¸ êµ­í† ì§€ë¦¬ì› ì§€ë„",
                weatherSuffix: "ì˜ ë‚ ì”¨",
                searchPrefix: "ì´ ì¥ì†Œì— ëŒ€í•´ ê²€ìƒ‰",
                notFoundMsg: "ê²€ìƒ‰ì–´ì˜ ì² ìë¥¼ í™•ì¸í•˜ê±°ë‚˜ ë‹¤ë¥¸ í‚¤ì›Œë“œë¥¼ ì‹œë„í•´ ë³´ì„¸ìš”.",
                btnSearchGoogle: "ğŸ” Google ê²€ìƒ‰",
                labelBase: "ê¸°ë³¸ ì§€ë„ - í‘œì¤€",
                labelMono: "ëª¨ë…¸í†¤/íŠ¹ìˆ˜",
                labelCustom: "ì»¤ìŠ¤í…€ í…Œë§ˆ",
                labelSat: "ìœ„ì„± ì‚¬ì§„",
                labelOverlay: "ë°ì´í„° ì˜¤ë²„ë ˆì´",
                wikiLoader: "ìœ„í‚¤ë°±ê³¼ ê²€ìƒ‰ ì¤‘...",
                noWikiImage: "ìœ„í‚¤ë°±ê³¼ ì´ë¯¸ì§€ ì—†ìŒ",
                labelLangHeader: "ì–¸ì–´ ì„¤ì •",
                base_osm: "ğŸ—ºï¸ í‘œì¤€",
                base_roadmap: "ğŸš— ë„ë¡œ ì§€ë„",
                base_terrain: "â›°ï¸ ì§€í˜•ë„",
                base_english: "ğŸ‡ºğŸ‡¸ ì˜ì–´ ì§€ë„",
                base_gsistd: "ğŸ—¾ êµ­í† ì§€ë¦¬ì› í‘œì¤€",
                base_dark: "ğŸ•¶ï¸ ë‹¤í¬",
                base_grayscale: "âšª ê·¸ë ˆì´",
                base_bw: "ğŸ í‘ë°±",
                base_lightgray: "âšª ë¼ì´íŠ¸ ê·¸ë ˆì´",
                base_rader_blue: "ğŸ“¡ ë¸”ë£¨ ë ˆì´ë”",
                base_rader_dark: "ğŸ›°ï¸ ë‹¤í¬ ë ˆì´ë”",
                base_satellite_g: "ğŸ›°ï¸ ìœ„ì„± ì‚¬ì§„",
                base_satellite_hybrid: "ğŸ·ï¸ í•˜ì´ë¸Œë¦¬ë“œ",
                base_gsiortho: "ğŸ“¸ êµ­í† ì§€ë¦¬ì› í•­ê³µ",
                base_esri: "ğŸŒ Esri ìœ„ì„±",
                btn_hybrid: "ğŸ·ï¸ ë¼ë²¨",
                btn_traffic: "ğŸš¥ êµí†µ ìƒí™©",
                btn_transit: "ğŸšƒ ì² ë„ë§",
                btn_eez: "ğŸš¢ ë°°íƒ€ì  ê²½ì œìˆ˜ì—­(EEZ)",
                btn_terminator: "ğŸŒ˜ ë°¤ë‚® ë¼ì¸",
                btn_clock: "ğŸ•’ ì„¸ê³„ ì‹œê³„ãƒ»ë‚ ì§œ",
                legendTitle: "ë²”ë¡€", 
                leg_fast: "ì›í™œ", leg_slow: "ì„œí–‰", leg_jam: "ì •ì²´", leg_rail: "ì² ë„ ë…¸ì„ ", 
                leg_eez: "ë°°íƒ€ì  ê²½ì œìˆ˜ì—­", leg_night: "ì•¼ê°„",
                tips: ["ì§€ë„ìƒì˜ ì•„ë¬´ ê³³ì´ë‚˜ í´ë¦­í•˜ë©´ í•´ë‹¹ ì¥ì†Œì˜ ì •ë³´ë¥¼ ì¦‰ì‹œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."]
            }
        };

        // ... existing functions ...
        function changeLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[id^="lang-"]').forEach(el => el.classList.remove('active-base'));
            document.getElementById(`lang-${lang}`)?.classList.add('active-base');
            applyUITranslation();
            updateClocks();
            refreshTip(); 
            updateLegend(); // Added call
            // åå‰ãŒç¢ºå®šã—ã¦ã„ã‚‹å ´åˆã¯ãƒ©ãƒ™ãƒ«é¡ã‚’å†æ›´æ–°
            if (currentLocationName) {
                updateDynamicLabels();
            }
        }

        function applyUITranslation() {
            const t = uiTranslations[currentLang] || uiTranslations['en'];
            document.getElementById('searchInput').placeholder = t.searchPlaceholder;
            const poiEl = document.getElementById('poiName');
            const poiDefaults = ["å ´æ‰€ã‚’é¸æŠ", "Select a Place", "é€‰æ‹©åœ°ç‚¹", "ì¥ì†Œ ì„ íƒ"];
            if (poiDefaults.includes(poiEl.innerText)) poiEl.innerText = t.poiDefault;
            
            document.getElementById('labelAddr').innerText = t.labelAddr;
            document.getElementById('labelWiki').innerText = t.labelWiki;
            document.getElementById('wikiLink').innerText = t.labelWikiMore;
            document.getElementById('labelQuiz').innerText = t.labelQuiz;
            document.getElementById('refreshQuizBtn').innerText = t.btnRefreshQuiz;
            document.getElementById('quizLoadingText').innerText = t.quizLoading;
            document.getElementById('labelTip').innerText = t.labelTip;
            document.getElementById('labelLinks').innerText = t.labelLinks;
            document.getElementById('btnGmaps').innerText = t.btnGmaps;
            document.getElementById('btnDirections').innerText = t.btnDirections;
            document.getElementById('btnReviews').innerText = t.btnReviews;
            document.getElementById('streetviewBtn').innerText = t.btnStreetView;
            document.getElementById('btnEarth').innerText = t.btnEarth;
            document.getElementById('btnGsi').innerText = t.btnGsi;
            document.getElementById('notFoundMsg').innerText = t.notFoundMsg;
            document.getElementById('searchGoogleBtn').innerText = t.btnSearchGoogle;
            document.getElementById('loaderText').innerText = t.wikiLoader;
            document.getElementById('noImageText').innerText = t.noWikiImage;
            document.getElementById('labelLangHeader').innerText = t.labelLangHeader;
            document.getElementById('labelBase').innerText = t.labelBase;
            document.getElementById('labelMono').innerText = t.labelMono;
            document.getElementById('labelCustom').innerText = t.labelCustom;
            document.getElementById('labelSat').innerText = t.labelSat;
            document.getElementById('labelOverlay').innerText = t.labelOverlay;

            const btnKeys = [
                'base_osm', 'base_roadmap', 'base_terrain', 'base_english', 'base_gsistd',
                'base_dark', 'base_grayscale', 'base_bw', 'base_lightgray',
                'base_rader_blue', 'base_rader_dark',
                'base_satellite_g', 'base_satellite_hybrid', 'base_gsiortho', 'base_esri',
                'btn_hybrid', 'btn_traffic', 'btn_transit', 'btn_eez', 'btn_terminator', 'btn_clock'
            ];
            btnKeys.forEach(k => {
                const el = document.getElementById(k.replace('_', '-'));
                if (el && t[k]) el.innerText = t[k];
            });
            
            updateDynamicLabels();
            updateLegend(); // Ensure legend text is updated
        }

        // å‹•çš„ãªå ´æ‰€åã‚’å«ã‚€ãƒ©ãƒ™ãƒ«ã®æ›´æ–°å‡¦ç†
        function updateDynamicLabels() {
            const t = uiTranslations[currentLang] || uiTranslations['en'];
            const name = currentLocationName || "";
            
            // å¤©æ°—ãƒœã‚¿ãƒ³ã®æ›´æ–°
            const weatherLabel = document.getElementById('weatherLabel');
            if (weatherLabel) {
                if (currentLang === 'ja' || currentLang === 'zh' || currentLang === 'ko') {
                    weatherLabel.innerText = name + t.weatherSuffix;
                } else {
                    weatherLabel.innerText = name + t.weatherSuffix;
                }
            }
            
            // æ¤œç´¢ãƒœã‚¿ãƒ³ã®æ›´æ–°
            const searchLabel = document.getElementById('searchLabel');
            if (searchLabel) {
                if (currentLang === 'ja') {
                    searchLabel.innerText = name + "ã«ã¤ã„ã¦æ¤œç´¢";
                } else if (currentLang === 'en') {
                    searchLabel.innerText = "Search about " + name;
                } else if (currentLang === 'zh') {
                    searchLabel.innerText = "æœç´¢å…³äº" + name + "çš„ä¿¡æ¯";
                } else if (currentLang === 'ko') {
                    searchLabel.innerText = name + "ì— ëŒ€í•´ ê²€ìƒ‰";
                }
            }
        }

        function updateClocks() {
            if (!overlays.clock || !map.hasLayer(overlays.clock)) return;
            overlays.clock.clearLayers();
            const now = new Date();
            const localeMap = { ja: 'ja-JP', zh: 'zh-CN', ko: 'ko-KR', en: 'en-US' };
            const locale = localeMap[currentLang] || localeMap['en'];
            
            cities.forEach(city => {
                try {
                    const cityName = city.name[currentLang] || city.name['en'];
                    
                    // Time Calculation
                    const timeString = now.toLocaleTimeString(locale, { timeZone: city.tz, hour: '2-digit', minute: '2-digit', hour12: false });
                    const dateString = now.toLocaleDateString(locale, { timeZone: city.tz, month: 'short', day: 'numeric' });
                    
                    // SunCalc Calculation
                    // Note: SunCalc uses the passed date object. 'now' is acceptable for general world clock purposes.
                    // For very high precision across datelines, one would create a date object specific to the city's calendar day.
                    const sunTimes = (typeof SunCalc !== 'undefined') ? SunCalc.getTimes(now, city.lat, city.lng) : null;
                    
                    let sunInfoHtml = '';
                    if (sunTimes && !isNaN(sunTimes.sunrise.getTime()) && !isNaN(sunTimes.sunset.getTime())) {
                        const sunriseStr = sunTimes.sunrise.toLocaleTimeString(locale, { timeZone: city.tz, hour: '2-digit', minute: '2-digit', hour12: false });
                        const sunsetStr = sunTimes.sunset.toLocaleTimeString(locale, { timeZone: city.tz, hour: '2-digit', minute: '2-digit', hour12: false });
                        sunInfoHtml = `<span class="clock-sun">ğŸŒ…${sunriseStr} ğŸŒ‡${sunsetStr}</span>`;
                    } else {
                        // Polar day/night or error
                        sunInfoHtml = `<span class="clock-sun">--:--</span>`;
                    }

                    const icon = L.divIcon({ 
                        className: 'clock-marker', 
                        html: `<div class="clock-label">
                                <strong>${cityName}</strong><br>
                                <span style="font-size:0.9em; opacity:0.8;">${dateString}</span>
                                <span class="clock-time">${timeString}</span>
                                ${sunInfoHtml}
                               </div>`, 
                        iconSize: [160, 90], 
                        iconAnchor: [80, 45] 
                    });
                    L.marker([city.lat, city.lng], { icon: icon }).addTo(overlays.clock);
                } catch(e) { console.error("Clock update error", e); }
            });
        }

        function updateTerminator() {
            if (overlays.terminator && typeof overlays.terminator.setTime === 'function') {
                overlays.terminator.setTime(new Date());
            }
        }
        
        // NEW: Update Legend function
        function updateLegend() {
            const activeKeys = [];
            
            // Check standard overlays that need legends
            ['traffic', 'transit', 'eez', 'terminator'].forEach(k => {
                if (map.hasLayer(overlays[k])) activeKeys.push(k);
            });

            const panel = document.getElementById('legendPanel');
            const content = document.getElementById('legendContent');
            const title = document.getElementById('legendTitle');
            
            if (activeKeys.length === 0) {
                panel.classList.add('hidden');
                panel.classList.remove('flex');
                return;
            }

            panel.classList.remove('hidden');
            
            const t = uiTranslations[currentLang] || uiTranslations['en'];
            title.innerText = t.legendTitle || "Legend";
            
            content.innerHTML = '';
            
            activeKeys.forEach(key => {
                const group = document.createElement('div');
                group.className = 'flex items-center gap-3 border-r border-gray-300 last:border-0 pr-4 last:pr-0 pl-1 first:pl-0';
                
                if (key === 'traffic') {
                    group.innerHTML = `
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span><span>${t.leg_fast}</span></div>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span><span>${t.leg_slow}</span></div>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span><span>${t.leg_jam}</span></div>
                    `;
                } else if (key === 'transit') {
                    group.innerHTML = `<div class="flex items-center gap-1"><span class="w-6 h-1 bg-gray-800 border-b border-white"></span><span>${t.leg_rail}</span></div>`;
                } else if (key === 'eez') {
                    group.innerHTML = `<div class="flex items-center gap-1"><span class="w-6 h-1 border-t-2 border-dashed border-blue-600"></span><span>${t.leg_eez}</span></div>`;
                } else if (key === 'terminator') {
                    group.innerHTML = `<div class="flex items-center gap-1"><span class="w-3 h-3 bg-gray-900/50 border border-gray-600"></span><span>${t.leg_night}</span></div>`;
                }
                
                content.appendChild(group);
            });
        }

        function startTipRotation() { if (tipInterval) clearInterval(tipInterval); refreshTip(); tipInterval = setInterval(refreshTip, 10000); }
        function refreshTip() {
            const el = document.getElementById('tipText'); if (!el) return;
            const t = uiTranslations[currentLang] || uiTranslations['en'];
            const langTips = t.tips || uiTranslations['en'].tips;
            el.classList.remove('animate-tip'); void el.offsetWidth; el.classList.add('animate-tip');
            let nt; do { nt = langTips[Math.floor(Math.random() * langTips.length)]; } while (nt === el.innerText && langTips.length > 1); el.innerText = nt;
        }

        async function generateQuiz() {
            if (!currentLocationName || !currentWikiText) return;
            const qs = document.getElementById('quizSection'), ql = document.getElementById('quizLoading'), qc = document.getElementById('quizContent'), qq = document.getElementById('quizQuestion'), qo = document.getElementById('quizOptions'), rb = document.getElementById('refreshQuizBtn');
            qs.classList.remove('hidden'); ql.classList.remove('hidden'); qc.classList.add('hidden'); rb.disabled = true;
            const langNameMap = { ja: 'Japanese', zh: 'Chinese', ko: 'Korean', en: 'English' };
            const langName = langNameMap[currentLang] || 'English';
            const systemPrompt = `Expert trivia creator. Valid JSON only. Language: ${langName}. 3 options about ${currentLocationName}. Format: {"question": "...", "options": ["...", "...", "..."], "correctIndex": 0, "explanation": "..."}`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Place: ${currentLocationName}\nContext: ${currentWikiText}` }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { responseMimeType: "application/json" } })
                });
                const data = await response.json(); const quiz = JSON.parse(data.candidates[0].content.parts[0].text);
                
                // Shuffle options randomly
                const correctOption = quiz.options[quiz.correctIndex];
                for (let i = quiz.options.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [quiz.options[i], quiz.options[j]] = [quiz.options[j], quiz.options[i]];
                }
                quiz.correctIndex = quiz.options.indexOf(correctOption);

                qq.innerText = quiz.question; qo.innerHTML = '';
                quiz.options.forEach((opt, idx) => {
                    const btn = document.createElement('button'); btn.className = 'quiz-option'; btn.innerText = opt;
                    btn.onclick = () => {
                        qo.querySelectorAll('.quiz-option').forEach(b => b.disabled = true);
                        if (idx === quiz.correctIndex) { btn.classList.add('correct'); btn.innerText += " âœ…"; }
                        else { btn.classList.add('incorrect'); btn.innerText += " âŒ"; qo.querySelectorAll('.quiz-option')[quiz.correctIndex].classList.add('correct'); }
                        const exp = document.createElement('div'); exp.className = 'mt-4 p-4 bg-purple-100/50 rounded-2xl text-xs font-bold text-purple-900/70 leading-relaxed border border-purple-200';
                        exp.innerHTML = quiz.explanation; qo.appendChild(exp);
                    };
                    qo.appendChild(btn);
                });
                ql.classList.add('hidden'); qc.classList.remove('hidden');
            } catch (e) { ql.classList.add('hidden'); qc.classList.remove('hidden'); } finally { rb.disabled = false; }
        }

        async function fetchWikipediaData(title) {
            const container = document.getElementById('wikiContainer'), text = document.getElementById('wikiText'), link = document.getElementById('wikiLink'), loader = document.getElementById('poiImageLoader'), img = document.getElementById('poiImage'), ph = document.getElementById('noImagePlaceholder');
            container.classList.add('hidden'); document.getElementById('quizSection').classList.add('hidden');
            loader.classList.remove('hidden'); img.classList.add('hidden'); ph.classList.add('hidden');
            try {
                const res = await fetch(`https://${currentLang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`);
                const data = await res.json();
                if (data.extract) {
                    currentWikiText = data.extract; text.innerText = data.extract;
                    if (link && data.content_urls) link.href = data.content_urls.desktop.page;
                    container.classList.remove('hidden'); setTimeout(generateQuiz, 10);
                } else currentWikiText = "";
                if (data.thumbnail?.source) { img.src = data.thumbnail.source; img.onload = () => { loader.classList.add('hidden'); img.classList.remove('hidden'); }; }
                else { loader.classList.add('hidden'); ph.classList.remove('hidden'); }
            } catch (e) { loader.classList.add('hidden'); ph.classList.remove('hidden'); currentWikiText = ""; }
        }

        function getSeaNameFallback(lat, lng) {
            const isJa = currentLang === 'ja';
            if (lat > 20 && lat < 50 && lng > 115 && lng < 160) {
                if (lng < 138 && lat > 34) return isJa ? "æ—¥æœ¬æµ·" : "Sea of Japan";
                if (lng < 130 && lat < 34) return isJa ? "æ±ã‚·ãƒŠæµ·" : "East China Sea";
                if (lng > 140 && lat > 30) return isJa ? "åŒ—å¤ªå¹³æ´‹" : "North Pacific Ocean";
                if (lng > 125 && lat < 30) return isJa ? "ãƒ•ã‚£ãƒªãƒ”ãƒ³æµ·" : "Philippine Sea";
                if (lat > 44 && lng > 140) return isJa ? "ã‚ªãƒ›ãƒ¼ãƒ„ã‚¯æµ·" : "Sea of Okhotsk";
                return isJa ? "åŒ—å¤ªå¹³æ´‹" : "North Pacific Ocean";
            }
            if (lng > 100 || lng < -70) {
                if (lat > 0) return isJa ? "åŒ—å¤ªå¹³æ´‹" : "North Pacific Ocean";
                return isJa ? "å—å¤ªå¹³æ´‹" : "South Pacific Ocean";
            }
            if (lng > -70 && lng < 20) {
                if (lat > 0) return isJa ? "åŒ—å¤§è¥¿æ´‹" : "North Atlantic Ocean";
                return isJa ? "å—å¤§è¥¿æ´‹" : "South Atlantic Ocean";
            }
            if (lng > 20 && lng < 100) return isJa ? "ã‚¤ãƒ³ãƒ‰æ´‹" : "Indian Ocean";
            if (lat > 70) return isJa ? "åŒ—æ¥µæµ·" : "Arctic Ocean";
            if (lat < -60) return isJa ? "å—æ¥µæµ·" : "Southern Ocean";
            return isJa ? "æµ·æ´‹" : "Ocean";
        }

        async function updateUI(lat, lng, searchResult = null) {
            currentLat = lat; currentLng = lng;
            document.getElementById('sidePanel').classList.remove('panel-hidden');
            ['imageSection','addressSection','linksSection','tipSection'].forEach(id => document.getElementById(id).classList.remove('hidden'));
            document.getElementById('notFoundSection').classList.add('hidden');
            if (marker) map.removeLayer(marker); marker = L.marker([lat, lng]).addTo(map);

            if (searchResult) {
                let zoom = 12;
                if (searchResult.type === 'country') zoom = 4;
                else if (['state', 'prefecture'].includes(searchResult.type)) zoom = 7;
                map.flyTo([lat, lng], zoom, { animate: true, duration: 0.8 });
            }

            try {
                let info;
                // ä¿®æ­£: æ¤œç´¢çµæœ(searchResult)ãŒã‚ã‚Šã€ãã“ã«ä½æ‰€æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€
                // æ–°ãŸã«APIã‚’å©ã‹ãšãã®æƒ…å ±ã‚’å„ªå…ˆä½¿ç”¨ã™ã‚‹ï¼ˆæƒ…å ±ã®é£Ÿã„é•ã„ã‚’é˜²ããŸã‚ï¼‰
                if (searchResult && searchResult.address) {
                    info = searchResult;
                } else {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=${currentLang}&addressdetails=1&zoom=18`);
                    info = await res.json();
                }
                
                const addr = info.address || {};
                
                // åç§°æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„: 
                // æ¤œç´¢çµæœã®åç§°(info.name)ãŒã‚ã‚Œã°ãã‚Œã‚’æœ€å„ªå…ˆã—ã€ãªã‘ã‚Œã°ä½æ‰€è¦ç´ ã‹ã‚‰æ±ºå®šã™ã‚‹
                let name = info.name || "";
                
                if (!name || !isNaN(name)) { // åå‰ãŒç„¡ã„ã€ã¾ãŸã¯æ•°å­—ã ã‘ã®å ´åˆã¯ä½æ‰€ã‹ã‚‰æ§‹ç¯‰
                    if (addr.village || addr.town || addr.city || addr.suburb || addr.neighbourhood) {
                        name = addr.neighbourhood || addr.suburb || addr.village || addr.town || addr.city;
                    } 
                    else if (addr.state || addr.country) {
                        name = addr.state || addr.country;
                    }
                    else if (addr.sea || addr.ocean) {
                        name = addr.sea || addr.ocean;
                    }
                }
                
                // æµ·æ´‹åãªã©ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if ((!name && (info.type === "sea" || info.type === "ocean" || info.category === "natural")) || (info.display_name && !name)) {
                     name = info.name || info.display_name.split(',')[0];
                }

                const blacklist = ["æµ·", "Sea", "ä¸æ˜", "Unnamed Road", "Unnamed", "æ°´åŸŸ", "Water", "Ocean", "æµ·æ´‹"];
                if (!name || blacklist.some(b => name === b)) {
                    if (Object.keys(addr).length > 2 && !addr.sea && !addr.ocean) {
                         name = info.name || info.display_name.split(',')[0];
                    } else {
                         name = getSeaNameFallback(lat, lng);
                    }
                }

                // å›½åãƒ»éƒ½é“åºœçœŒãªã©ã‚’æ˜ç¤ºçš„ã«çµ„ã¿ç«‹ã¦ã‚‹
                let locationContext = "";
                const parts = [];
                
                // é‡è¤‡è¿½åŠ ã‚’é˜²ããŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆä¿®æ­£ï¼šåå‰ã¨åŒã˜è¦ç´ ã¯ä½æ‰€æ¬„ã«è¿½åŠ ã—ãªã„ï¼‰
                const addPart = (val) => {
                    if (val && !parts.includes(val) && val !== name) parts.push(val);
                };

                // åˆ©ç”¨å¯èƒ½ãªä½æ‰€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’åé›†
                if (['ja', 'zh', 'ko'].includes(currentLang)) {
                    // ã‚¢ã‚¸ã‚¢åœï¼šåºƒåŸŸ -> è©³ç´°
                    if (addr.country) addPart(addr.country);
                    if (addr.province) addPart(addr.province);
                    if (addr.state) addPart(addr.state); // éƒ½é“åºœçœŒ
                    if (addr.region) addPart(addr.region);
                    if (addr.county) addPart(addr.county); // éƒ¡
                    if (addr.city) addPart(addr.city); // å¸‚
                    if (addr.ward) addPart(addr.ward); // åŒº
                    if (addr.town) addPart(addr.town); // ç”º
                    if (addr.village) addPart(addr.village); // æ‘
                    if (addr.city_district) addPart(addr.city_district); // åœ°åŒºãƒ»ä¸ç›®
                    if (addr.suburb) addPart(addr.suburb);
                    if (addr.neighbourhood) addPart(addr.neighbourhood);
                } else {
                    // æ¬§ç±³åœï¼šè©³ç´° -> åºƒåŸŸ
                    if (addr.neighbourhood) addPart(addr.neighbourhood);
                    if (addr.suburb) addPart(addr.suburb);
                    if (addr.city_district) addPart(addr.city_district);
                    if (addr.town) addPart(addr.town);
                    if (addr.village) addPart(addr.village);
                    if (addr.ward) addPart(addr.ward);
                    if (addr.city) addPart(addr.city);
                    if (addr.county) addPart(addr.county);
                    if (addr.state) addPart(addr.state);
                    if (addr.province) addPart(addr.province);
                    if (addr.country) addPart(addr.country);
                }

                // é‡è¤‡ã‚’é™¤å»ã—ã¦çµåˆ
                locationContext = parts.join(' / ');

                // æ§‹ç¯‰ã§ããªã‹ã£ãŸå ´åˆã¯ display_name ã‚’ä½¿ç”¨
                if (!locationContext && info.display_name) {
                    locationContext = info.display_name;
                }

                currentLocationName = name;
                document.getElementById('poiName').innerText = currentLocationName;
                document.getElementById('addrText').innerText = locationContext || (currentLang === 'ja' ? `${currentLocationName}å‘¨è¾º` : `Area around ${currentLocationName}`);
                
                updateDynamicLabels();
                fetchWikipediaData(currentLocationName);
            } catch(e) {
                 currentLocationName = getSeaNameFallback(lat, lng);
                 document.getElementById('poiName').innerText = currentLocationName;
                 document.getElementById('addrText').innerText = currentLang === 'ja' ? `${currentLocationName}åŸŸå†…` : `Area within ${currentLocationName}`;
                 
                 updateDynamicLabels();
                 fetchWikipediaData(currentLocationName);
            }
        }

        async function performSearch() {
            const q = document.getElementById('searchInput')?.value; if (!q) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&addressdetails=1&accept-language=${currentLang}`);
                const data = await res.json();
                if (data?.length > 0) updateUI(parseFloat(data[0].lat), parseFloat(data[0].lon), data[0]);
                else showNotFound(q);
            } catch (e) { showNotFound(q); }
        }

        function showNotFound(q) {
            document.getElementById('sidePanel').classList.remove('panel-hidden');
            ['imageSection','addressSection','wikiContainer','linksSection','tipSection','quizSection'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('notFoundSection').classList.remove('hidden');
            document.getElementById('poiName').innerText = q;
            currentLocationName = q;
            updateDynamicLabels();
        }

        function changeBase(t) {
            if (!baseLayers[t]) return;
            document.querySelectorAll('[id^="base-"]').forEach(el => el.classList.remove('active-base'));
            document.getElementById(`base-${t}`)?.classList.add('active-base');
            if (map.hasLayer(baseLayers[activeBaseId])) map.removeLayer(baseLayers[activeBaseId]);
            baseLayers[t].addTo(map); activeBaseId = t;
            if (map.hasLayer(overlays.hybrid)) { map.removeLayer(overlays.hybrid); overlays.hybrid.addTo(map); }
        }

        function toggleOverlay(t) {
            const btn = document.getElementById(`btn-${t}`);
            
            if (!overlays[t]) return;
            
            if (map.hasLayer(overlays[t])) { 
                map.removeLayer(overlays[t]); 
                btn?.classList.remove('active-overlay'); 
                if (t === 'clock') clearInterval(clockInterval); 
                if (t === 'terminator') clearInterval(terminatorInterval);
            }
            else { 
                overlays[t].addTo(map); 
                btn?.classList.add('active-overlay');
                if (t === 'clock') { updateClocks(); clockInterval = setInterval(updateClocks, 30000); }
                if (t === 'terminator') { updateTerminator(); terminatorInterval = setInterval(updateTerminator, 1000); }
            }
            updateLegend(); // Added
        }

        function toggleLayerMenu() { document.getElementById('layerMenu')?.classList.toggle('hidden'); }
        function toggleSidePanel() { document.getElementById('sidePanel')?.classList.toggle('panel-hidden'); }
        function closeSidePanel() { document.getElementById('sidePanel')?.classList.add('panel-hidden'); if (marker) { map.removeLayer(marker); marker = null; } }
        
        function searchGoogleWeb() {
            if (!currentLocationName) return;
            window.open(`https://www.google.com/search?q=${encodeURIComponent(currentLocationName)}`, '_blank');
        }

        function navExternal(t) {
            if (!currentLat) return;
            let u = '';
            switch(t) {
                case 'gmaps': u = `https://www.google.com/maps/search/?api=1&query=${currentLat},${currentLng}`; break;
                case 'directions': u = `https://www.google.com/maps/dir/?api=1&destination=${currentLat},${currentLng}`; break;
                case 'streetview': u = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${currentLat},${currentLng}`; break;
                case 'weather': u = `https://www.google.com/search?q=${encodeURIComponent(currentLocationName + ' å¤©æ°—')}`; break;
                case 'earth': u = `https://earth.google.com/web/@${currentLat},${currentLng},0a,1000d,35y,0h,0t,0r`; break;
                case 'search': u = `https://www.google.com/search?q=${encodeURIComponent(currentLocationName)}`; break;
                case 'gsi': u = `https://maps.gsi.go.jp/#15/${currentLat}/${currentLng}/&base=std`; break;
            }
            if (u) window.open(u, '_blank');
        }

        window.onload = init;
    </script>
</body>
</html>